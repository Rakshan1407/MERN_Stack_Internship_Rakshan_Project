name: DEV CI + Manual Deploy Pipeline

on:
  push:
    branches:
      - dev

  workflow_dispatch:

jobs:
  # -----------------------------
  # 1Ô∏è‚É£ CI JOB (Auto ‚Äî Build & Verify)
  # -----------------------------
  ci-checks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Backend
      - name: Install Backend Dependencies
        working-directory: Personal_Finance_Manager_Project/backend
        run: npm install

      - name: Backend Build Check
        working-directory: Personal_Finance_Manager_Project/backend
        run: npm run build || echo "No backend build step"

      # Frontend
      - name: Install Frontend Dependencies
        working-directory: Personal_Finance_Manager_Project/frontend
        run: npm install

      - name: Build Frontend
        working-directory: Personal_Finance_Manager_Project/frontend
        run: npm run build

  # -----------------------------
  # 2Ô∏è‚É£ MANUAL DEPLOY JOB
  # -----------------------------
  deploy-to-aws:
    needs: ci-checks
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup SSH Agent
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy on EC2
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          script: |
            set -e

            cd ${{ secrets.APP_PATH }}

            if [ ! -d "Personal_Finance_Manager_Project" ]; then
              git clone https://github.com/Rakshan1407/MERN_Stack_Internship_Rakshan_Project.git
            fi

            cd Personal_Finance_Manager_Project
            git pull origin dev

            # Backend
            cd backend
            npm install
            pm2 describe pfm-backend > /dev/null \
              && pm2 restart pfm-backend \
              || pm2 start server.js --name pfm-backend
            pm2 save

            # Frontend
            cd ../frontend
            npm install
            npm run build

            sudo rm -rf /var/www/html/*
            sudo cp -r build/* /var/www/html/

      # -----------------------------
      # EMAIL ‚Äî SUCCESS
      # -----------------------------
      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Infomind ‚Äî DEV Deployment SUCCESS"
          to: ${{ secrets.EMAIL_TO }}
          from: "Infomind CI Pipeline"
          body: |
            Deployment Successful üéØ

            Project: Personal Finance Manager
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Run URL:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # -----------------------------
      # EMAIL ‚Äî FAILURE
      # -----------------------------
      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USER }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "Infomind ‚Äî DEV Deployment FAILED ‚ùå"
          to: ${{ secrets.EMAIL_TO }}
          from: "Infomind CI Pipeline"
          body: |
            Deployment Failed ‚ùå

            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Logs:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
